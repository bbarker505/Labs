"0","CM_movement <- function(sex, pos_prev, di, ris, flag, theta, dirs_cast) {"
"0","  "
"0","  # Direction in previous step"
"0","  ri_prev <- as.numeric(slice_tail(ris)) "
"0","  "
"0","  # Randomly sample a direction from a uniform distribution"
"0","  if (sex == ""female"") {"
"0","    "
"0","    directions_f <- data.frame("
"0","      direction = round(runif(n = 10000, min = -180, max = 180), 0)"
"0","      )"
"0","    ri <- sample(directions_f$direction, 1, replace = TRUE)"
"0","    "
"0","  } else if (sex == ""male"" & flag == 0) {"
"0","    "
"0","    # Incorporate path meander of males (sample from a Gaussian distribution of "
"0","    # possible directions centered on straight ahead (mean = direction of previous step) "
"0","    # and having a specified circular standard deviation (c.s.d) of 40"
"0","    directions_m <- data.frame("
"0","        direction = round(rtnorm(1000, mean = ri_prev, sd = 40, lower = -180, upper = 180), 0))"
"0","  "
"0","    # The male will fly in a crosswind direction, sampled from the nonuniform "
"0","    # probability distribution of angles of flight. After having accounted for"
"0","    # path meander, now we need to know the probability of flight in that direction"
"0","    # according to the tendency to fly in a crosswind direction. "
"0","    # The ""dirs_cast"" has these probabilities (added via a join)"
"0","    # Filter out direction probabilities present in directions_m"
"0","    directions <- left_join(directions_m, dirs_cast, by = ""direction"") %>%"
"0","      distinct(direction, .keep_all = TRUE)"
"0","    "
"0","    # Center direction perpendicular to wind direction"
"0","    directions$direction <- directions$direction + wind_dir_mid + 90"
"0","    "
"0","    # Sample directions according to probability weights"
"0","    directions <- directions %>% replace(is.na(.), 0) # May be issues w/ NA values"
"0","    ri <- sample(directions$direction, size = 1, prob = directions$prob)"
"0","    "
"0","    # If male moth has detected a plume (resulting in a ""flag""), then it flies "
"0","    # directly upwind at maximum flight speed until finding the source. "
"0","    # TO DO: male may lose the plume and fly elsewhere - how to incorporate this?"
"0","  } else if (sex == ""male"" & flag == 1) {"
"0","    "
"0","    # Add angle of pheromone trap to this to get angles relative to the trap"
"0","    # Path meander is not considered here since moth has already detected a plume"
"0","    directions <- data.frame(direction = c(-3:3), prob = 1)"
"0","    directions$direction <- directions$direction + theta"
"0","    "
"0","    # Sample row randomly - all have same probability of occurring"
"0","    directions <- directions %>% replace(is.na(.), 0) # May be issues w/ NA values"
"0","    ri <- sample(directions$direction, size = 1)"
"0","    "
"0","  }"
"0","  "
"0","  # Save direction for next step"
"0","  ris <- add_row(ris, ri = ri)"
"0","  "
"0","  # Calculate new position"
"0","  xi.1 <- as.numeric(x_fun(xi = pos_prev$x, di, ri)) # new x coord"
"0","  yi.1 <- as.numeric(y_fun(yi = pos_prev$y, di, ri)) # new y coord"
"0","  "
"0","  # Return direction and position data frames"
"0","  return(list(ris, xi.1, yi.1))"
"0",""
"0","}"
