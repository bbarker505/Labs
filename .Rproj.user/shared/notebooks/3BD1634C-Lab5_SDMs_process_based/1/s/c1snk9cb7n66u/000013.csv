"0","# Accumulate degree days and reclass cells to NA with temperature exclusion"
"0","# NA for exclusion means that DD accum cannot occur anymore with incomplete"
"0","# generation development and no oviposition to next generation. "
"0","for (d in dats) {"
"0","  "
"0","    #print(d)"
"0",""
"0","    # Read in that day's PRISM raster files"
"0","    tmin_pattern <- paste(""(PRISM_tmin_)(.*)("", d,"")(.*)(.tif)$"", sep="""")"
"0","    tmin_fl <- list.files(prism_dir, pattern=tmin_pattern, full.names=TRUE)"
"0","    tmax_pattern <- paste(""(PRISM_tmax_)(.*)("", d,"")(.*)(.tif)$"", sep="""")"
"0","    tmax_fl <- list.files(prism_dir, pattern=tmax_pattern, full.names=TRUE)"
"0","    "
"0","    # Rasters "
"0","    tmin <- rast(tmin_fl)"
"0","    tmax <- rast(tmax_fl)"
"0","    "
"0","    #Create stage specific lifestage binary rasters"
"0","    #Limits operations to a mask for cells that are in that lifestage"
"0","    #This is what allows for pixel by pixel tracking of what lifestage"
"0","    # that cell is in"
"0","    LS0 <- Lifestage == 0"
"0","    LS1 <- Lifestage == 1"
"0","    LS2 <- Lifestage == 2"
"0","    LS3 <- Lifestage == 3"
"0",""
"0","    # Cold stress"
"0","    coldmask <- tmin < coldstressTHRESH  # make todays cold mask"
"0","    coldstress <- coldmask * abs(coldstressTHRESH - tmin) # compute todays cold stress DDs"
"0","    coldunitsCUM <- coldunitsCUM + coldstress"
"0","    # ASSUME NEW -2=severe -1=mod 0=none throughout"
"0","    coldEXCL <- Cond(coldunitsCUM >= coldstressMAX2,-2,Cond(coldunitsCUM >= coldstressMAX1,-1,0))"
"0","    "
"0","    # Heat stress"
"0","    heatmask <- tmax > heatstressTHRESH  # make todays heat mask"
"0","    heatstress <- heatmask * abs(tmax - heatstressTHRESH) # compute todays heat stress DDs"
"0","    heatunitsCUM <- heatunitsCUM + heatstress"
"0","    heatEXCL <- Cond(heatunitsCUM >= heatstressMAX2,-2,Cond(heatunitsCUM >= heatstressMAX1,-1,0))"
"0","    "
"0","    # All climate stress (cold + heat)"
"0","    allEXCL <- Cond((coldEXCL == 0) & (heatEXCL == 0),0,"
"0","               Cond((coldEXCL == -1) & (heatEXCL >= -1),-1,"
"0","               Cond((coldEXCL >= -1) & (heatEXCL == -1),-1,-2)))"
"0",""
"0","    # Loop through each life stage"
"0","    for (i in 1:4) {"
"0","      if (i==1){"
"0","         #developmental degree days  (zero values for temps below LDT)"
"0","         dd0 <- AvgDD(tmax,tmin,eggLDT,eggUDT)"
"0","         dd0 <- dd0 * LS0"
"0","         #Accumulate degree days"
"0","         DDaccum <- DDaccum + dd0"
"0","         #Calculate lifestage progression"
"0","         progress0 <- (DDaccum >= eggDD) * LS0"
"0","         Lifestage <- Lifestage + progress0"
"0","         #Reset the DDaccum cells to zero for cells that progressed to next lifestage"
"0","         progress0 <- (DDaccum >= eggDD) * LS0"
"0","         DDaccum <- Cond(progress0 == 0, DDaccum, 0)"
"0",""
"0","      } else if (i == 2) {"
"0","         # developmental degree days"
"0","         dd1 <- AvgDD(tmax,tmin,larvaeLDT,larvaeUDT)"
"0","         dd1 <- dd1 * LS1"
"0","         # Accumulate degree days"
"0","         DDaccum <- DDaccum + dd1"
"0","         # Accumulate total degree days"
"0","         DDtotal <- DDtotal + dd1"
"0","         # Calculate lifestage progression"
"0","         progress1 <- (DDaccum >= larvaeDD) * LS1"
"0","         Lifestage <- Lifestage + progress1"
"0","         # Reset the DDaccum cells to zero for cells that progressed to next lifestage"
"0","         progress1 <- (DDaccum >= larvaeDD) * LS1"
"0","         DDaccum <- Cond(progress1 == 0, DDaccum, 0)"
"0",""
"0","      } else if (i == 3) {"
"0","         # developmental degree days"
"0","         dd2 <- AvgDD(tmax,tmin,pupaeLDT,pupaeUDT)"
"0","         dd2 <- dd2 * LS2"
"0","         DDaccum <- DDaccum + dd2"
"0","         # Calculate lifestage progression"
"0","         progress2 <- (DDaccum >= pupaeDD) * LS2"
"0","         Lifestage <- Lifestage + progress2"
"0","         # Reset the DDaccum cells to zero for cells that progressed to next lifestage"
"0","         progress2 <- (DDaccum >= pupaeDD) * LS2"
"0","         DDaccum <- Cond(progress2 == 0, DDaccum, 0)"
"0",""
"0","      } else { # adult stage, or time to 50% oviposition"
"0","         # developmental degree days"
"0","         dd3 <- AvgDD(tmax,tmin,adultLDT,adultUDT)"
"0","         dd3 <- dd3 * LS3"
"0","         # Accumulate degree days"
"0","         DDaccum <- DDaccum + dd3"
"0","         # Reset lifestage progression to 0 for oviposition"
"0","         progress3 <- (DDaccum >= adultDD) * LS3"
"0","         Lifestage <- Cond(progress3 == 1,0, Lifestage)"
"0","         # Reset the DDaccum cells to zero for cells that progressed to next lifestage"
"0","         DDaccum <- Cond(progress3 == 1,0, DDaccum)"
"0","         # Increment NumGen + 1"
"0","         NumGen <- NumGen + progress3"
"0","         }"
"0","    }"
"0","}"
